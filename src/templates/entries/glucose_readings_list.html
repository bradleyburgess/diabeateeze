{% extends "app_layout.html" %}

{% block title %}Blood Glucose Readings{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-droplet-fill me-2"></i>Blood Glucose Readings</h1>
        <div class="d-flex gap-2">
            {% include "entries/_export_button.html" with show_glucose_export_options=True %}
            <a href="{% url 'entries:glucose_reading_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Add Reading
            </a>
        </div>
    </div>

    <!-- Filter Controls -->
    {% include "entries/_date_filter.html" with filter_label="Readings" clear_url=request.path %}

    <!-- Page Size Control -->
    <div class="d-flex justify-content-end align-items-center mb-3">
        <label for="pageSizeSelect" class="mb-0 me-2">Rows per page:</label>
        <select id="pageSizeSelect" class="form-select form-select-sm" style="width: auto;">
            <option value="10" {% if page_size == 10 %}selected{% endif %}>10</option>
            <option value="25" {% if page_size == 25 %}selected{% endif %}>25</option>
            <option value="50" {% if page_size == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if page_size == 100 %}selected{% endif %}>100</option>
        </select>
    </div>

    {% if page_obj %}
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>
                                    <a href="?sort={% if sort_order == 'desc' %}asc{% else %}desc{% endif %}&page_size={{ page_size }}&start_date={{ start_date }}&end_date={{ end_date }}" 
                                       class="text-decoration-none color-inherit"
                                       title="Sort by date">
                                        Date & Time
                                        {% if sort_order == 'desc' %}
                                            <i class="bi bi-sort-down"></i>
                                        {% else %}
                                            <i class="bi bi-sort-up"></i>
                                        {% endif %}
                                    </a>
                                </th>
                                <th>Reading</th>
                                <th>Added By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reading in page_obj %}
                                <tr>
                                    <td>{{ reading.occurred_at|date:"Y-m-d H:i" }}</td>
                                    <td>{{ reading.value }} {{ reading.get_unit_display }}</td>
                                    <td>
                                        {% if reading.last_modified_by %}
                                            {{ reading.last_modified_by.get_full_name }}
                                        {% else %}
                                            <em class="text-muted">Unknown</em>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'entries:glucose_reading_edit' reading.pk %}" 
                                           class="btn btn-sm btn-outline-primary" 
                                           title="Edit reading">
                                            <i class="bi bi-pencil"></i> Edit
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                {% include 'includes/_pagination.html' %}
            </div>
        </div>
    {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>No glucose readings found.
        </div>
    {% endif %}

    <!-- Charts Section -->
    {% if chart_data %}
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title mb-3">Glucose Trends</h5>
                
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs" id="chartTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="timeline-tab" data-bs-toggle="tab" 
                                data-bs-target="#timeline-chart" type="button" role="tab" 
                                aria-controls="timeline-chart" aria-selected="true">
                            Timeline View
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="overlay-tab" data-bs-toggle="tab" 
                                data-bs-target="#overlay-chart" type="button" role="tab" 
                                aria-controls="overlay-chart" aria-selected="false">
                            24-Hour Overlay
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="average-tab" data-bs-toggle="tab" 
                                data-bs-target="#average-chart" type="button" role="tab" 
                                aria-controls="average-chart" aria-selected="false">
                            Daily Averages
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content mt-3" id="chartTabContent">
                    <!-- Timeline Chart -->
                    <div class="tab-pane fade show active" id="timeline-chart" role="tabpanel" 
                         aria-labelledby="timeline-tab">
                        <canvas id="timelineCanvas" style="max-height: 400px;"></canvas>
                    </div>
                    
                    <!-- 24-Hour Overlay Chart -->
                    <div class="tab-pane fade" id="overlay-chart" role="tabpanel" 
                         aria-labelledby="overlay-tab">
                        <canvas id="overlayCanvas" style="max-height: 400px;"></canvas>
                    </div>
                    
                    <!-- Daily Averages Chart -->
                    <div class="tab-pane fade" id="average-chart" role="tabpanel" 
                         aria-labelledby="average-tab">
                        <canvas id="averageCanvas" style="max-height: 400px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<script>
    // Handle page size change
    document.getElementById('pageSizeSelect').addEventListener('change', function() {
        const pageSize = this.value;
        const url = new URL(window.location);
        url.searchParams.set('page_size', pageSize);
        url.searchParams.set('page', '1'); // Reset to first page when changing size
        // Preserve filter and sort parameters
        const currentParams = new URLSearchParams(window.location.search);
        const preserveParams = ['start_date', 'end_date', 'filter', 'sort'];
        preserveParams.forEach(param => {
            if (currentParams.has(param)) {
                url.searchParams.set(param, currentParams.get(param));
            }
        });
        window.location.href = url.toString();
    });

    // Chart.js configuration
    {% if chart_data %}
    document.addEventListener('DOMContentLoaded', function() {
        // Timeline Chart
        const timelineCtx = document.getElementById('timelineCanvas').getContext('2d');
        const chartData = JSON.parse('{{ chart_data|escapejs }}');
        
        const timelineChart = new Chart(timelineCtx, {
            type: 'line',
            data: {
                labels: chartData.map(d => new Date(d.timestamp)),
                datasets: [{
                    label: 'Blood Glucose',
                    data: chartData.map(d => d.value),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const date = new Date(context[0].label);
                                return date.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            displayFormats: {
                                hour: 'MMM d, HH:mm',
                                day: 'MMM d',
                            },
                            tooltipFormat: 'MMM d, yyyy HH:mm'
                        },
                        title: {
                            display: true,
                            text: 'Date & Time'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Blood Glucose'
                        },
                        beginAtZero: false
                    }
                }
            }
        });

        // 24-Hour Overlay Chart
        const overlayCtx = document.getElementById('overlayCanvas').getContext('2d');
        const dailyData = JSON.parse('{{ daily_data|escapejs }}');
        
        // Generate colors for each day
        const colors = [
            'rgb(255, 99, 132)',
            'rgb(54, 162, 235)',
            'rgb(255, 206, 86)',
            'rgb(75, 192, 192)',
            'rgb(153, 102, 255)',
            'rgb(255, 159, 64)',
            'rgb(199, 199, 199)',
            'rgb(83, 102, 255)',
            'rgb(255, 99, 255)',
            'rgb(99, 255, 132)'
        ];
        
        const datasets = Object.keys(dailyData).map((date, index) => {
            const readings = dailyData[date];
            const color = colors[index % colors.length];
            
            return {
                label: date,
                data: readings.map(r => ({
                    x: r.hour_decimal,
                    y: r.value
                })),
                borderColor: color,
                backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.1)'),
                tension: 0.1,
                fill: false
            };
        });
        
        const overlayChart = new Chart(overlayCtx, {
            type: 'line',
            data: {
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: {
                    mode: 'nearest',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const hours = Math.floor(context[0].parsed.x);
                                const minutes = Math.round((context[0].parsed.x - hours) * 60);
                                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'linear',
                        min: 0,
                        max: 24,
                        ticks: {
                            stepSize: 2,
                            callback: function(value) {
                                return value.toString().padStart(2, '0') + ':00';
                            }
                        },
                        title: {
                            display: true,
                            text: 'Time of Day (24-hour)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Blood Glucose'
                        },
                        beginAtZero: false
                    }
                }
            }
        });
        
        // Daily Averages Chart
        const averageCtx = document.getElementById('averageCanvas').getContext('2d');
        const dailyAvgData = JSON.parse('{{ daily_avg_data|escapejs }}');
        
        const averageChart = new Chart(averageCtx, {
            type: 'line',
            data: {
                labels: dailyAvgData.map(d => d.date),
                datasets: [{
                    label: 'Daily Average',
                    data: dailyAvgData.map(d => d.average),
                    borderColor: 'rgb(153, 102, 255)',
                    backgroundColor: 'rgba(153, 102, 255, 0.1)',
                    tension: 0.1,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Average: ' + context.parsed.y.toFixed(1);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'MMM d'
                            },
                            tooltipFormat: 'MMM d, yyyy'
                        },
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Average Blood Glucose'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    });
    {% endif %}
</script>
{% endblock %}
